<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Shiv Video Vision</title>

  <link rel="stylesheet" href="css/style.css?v=10">
  <link rel="stylesheet" href="css/dark.css?v=10">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* Force layout mode by body class (prevents 2 menus on iPhone) */
    body.is-mobile .desktopOnly { display:none !important; }
    body.is-mobile .mobileOnly  { display:block !important; }

    body.is-desktop .desktopOnly { display:block !important; }
    body.is-desktop .mobileOnly  { display:none !important; }

    /* Desktop layout (old look) */
    .desktopLayout{
      display:flex;
      height: calc(100dvh - 56px);
      overflow:hidden;
    }
    .desktopSidebar{
      width:260px;
      background:#111;
      color:#fff;
      padding:12px;
      overflow:hidden;
    }
    .desktopSidebar h4{
      margin:12px 0 6px;
      padding:10px 8px;
      color:#aaa;
      font-size:12px;
      letter-spacing:.04em;
    }
    .desktopSidebar button{
      width:100%;
      text-align:left;
      background:transparent;
      border:0;
      color:#fff;
      padding:10px 8px;
      border-radius:10px;
      cursor:pointer;
      font-size:14px;
    }
    .desktopSidebar button:hover{
      background:rgba(255,255,255,0.08);
    }
    .desktopMainHost{
      flex:1;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      padding:12px;
    }
  </style>
</head>

<body class="no-scroll">
  <div class="appShell safe">

    <!-- MOBILE ONLY: overlay + drawer -->
    <div id="drawerOverlay" class="drawerOverlay mobileOnly"></div>

    <aside id="drawer" class="drawer mobileOnly">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
        <img src="assets/logo.png" style="height:26px;">
        <strong>Menu</strong>
      </div>

      <button onclick="navTo('dashboard'); closeDrawer()">üè† Dashboard</button>

      <h4 style="padding:10px 8px;color:#aaa;margin:8px 0 0;">ACCOUNTING</h4>
      <button onclick="navTo('upad'); closeDrawer()">üë∑ Upad</button>
      <button onclick="navTo('expenses'); closeDrawer()">üìí Expenses</button>
      <button onclick="navTo('salary'); closeDrawer()">üí∞ Salary</button>

      <h4 style="padding:10px 8px;color:#aaa;margin:8px 0 0;">INVOICE</h4>
      <button onclick="navTo('invoice'); closeDrawer()">üßæ Create Invoice</button>

      <div class="superadminOnly">
        <h4 style="padding:10px 8px;color:#aaa;margin:8px 0 0;">ADMIN</h4>
        <button onclick="navTo('userMgmt'); closeDrawer()">üõ° User Management</button>
        <button onclick="navTo('gst'); closeDrawer()">üìä GST</button>
        <button onclick="navTo('export'); closeDrawer()">üì§ Export</button>
      </div>

      <div style="margin-top:12px;border-top:1px solid rgba(255,255,255,.12);padding-top:10px;">
        <button onclick="logout()">üö™ Logout</button>
      </div>
    </aside>

    <!-- Header (shared) -->
    <header class="appHeader">
      <!-- Mobile back/menu only -->
      <button class="iconBtn backBtn mobileOnly" id="btnBack" title="Back"></button>
      <button class="iconBtn menuBtn mobileOnly" id="btnMenu" title="Menu"></button>

      <img src="assets/logo.png" alt="SVV">
      <strong>Shiv Video Vision</strong>

      <div style="margin-left:auto;display:flex;gap:10px;align-items:center;">
        <span id="netStatus" style="font-size:12px;"></span>
        <span id="syncCount" style="font-size:12px;"></span>
        <button class="iconBtn" id="btnTheme" title="Theme">üåô</button>
      </div>
    </header>

    <!-- DESKTOP ONLY: old sidebar layout -->
    <div class="desktopOnly desktopLayout">
      <aside class="desktopSidebar">
        <button onclick="showDashboard()">üè† Dashboard</button>

        <h4>ACCOUNTING</h4>
        <button onclick="loadSection('upad')">üë∑ Upad</button>
        <button onclick="loadSection('expenses')">üìí Expenses</button>
        <button onclick="loadSection('salary')">üí∞ Salary</button>

        <h4>INVOICE</h4>
        <button onclick="loadSection('invoice')">üßæ Create Invoice</button>

        <div class="superadminOnly">
          <h4>ADMIN</h4>
          <button onclick="loadSection('userMgmt')">üõ° User Management</button>
          <button onclick="loadSection('gst')">üìä GST</button>
          <button onclick="loadSection('export')">üì§ Export</button>
        </div>

        <button onclick="logout()" style="margin-top:20px;">üö™ Logout</button>
      </aside>

      <main id="desktopHost" class="desktopMainHost"></main>
    </div>

    <!-- MOBILE ONLY content host -->
    <main id="mobileHost" class="appMain mobileOnly"></main>

    <!-- Single content node used by accounting.js -->
    <div id="content"></div>

  </div>

  <script src="js/api.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/sync.js"></script>
  <script src="js/accounting.js"></script>

  <script>
    /* ---------- LAYOUT MODE (fix 2 menus on iPhone) ---------- */
    function applyMode(){
      const isDesktop = window.matchMedia("(min-width: 900px)").matches;
      document.body.classList.toggle("is-desktop", isDesktop);
      document.body.classList.toggle("is-mobile", !isDesktop);
      placeContent();
      // Close drawer if switching modes
      closeDrawer();
    }

    function placeContent(){
      const content = document.getElementById("content");
      const desktopHost = document.getElementById("desktopHost");
      const mobileHost = document.getElementById("mobileHost");
      const isDesktop = document.body.classList.contains("is-desktop");
      if (isDesktop) desktopHost.appendChild(content);
      else mobileHost.appendChild(content);
    }

    window.addEventListener("resize", applyMode);
    applyMode();

    /* ---------- THEME (fix white header + toggle not working) ---------- */
    function applyTheme(){
      const t = localStorage.getItem("theme") || "light";
      document.body.classList.toggle("dark", t === "dark");
    }

    function toggleTheme(){
      const nowDark = !document.body.classList.contains("dark");
      localStorage.setItem("theme", nowDark ? "dark" : "light");
      applyTheme();
    }

    document.getElementById("btnTheme").addEventListener("click", toggleTheme);
    applyTheme();

    /* ---------- MOBILE DRAWER ---------- */
    const drawer = document.getElementById("drawer");
    const overlay = document.getElementById("drawerOverlay");

    function openDrawer(){
      if (!drawer || !overlay) return;
      drawer.classList.add("open");
      overlay.classList.add("open");
    }
    function closeDrawer(){
      if (!drawer || !overlay) return;
      drawer.classList.remove("open");
      overlay.classList.remove("open");
    }
    window.closeDrawer = closeDrawer;

    const btnMenu = document.getElementById("btnMenu");
    if (btnMenu) btnMenu.addEventListener("click", openDrawer);
    if (overlay) overlay.addEventListener("click", closeDrawer);

    /* ---------- MOBILE BACK STACK ---------- */
    window.__navStack = window.__navStack || ["dashboard"];

    window.navTo = async function(section){
      if (section === "dashboard"){
        window.__navStack.push("dashboard");
        showDashboard();
        return;
      }
      window.__navStack.push(section);
      await loadSection(section);
    };

    function goBack(){
      if (!window.__navStack || window.__navStack.length <= 1){
        showDashboard();
        window.__navStack = ["dashboard"];
        return;
      }
      window.__navStack.pop();
      const prev = window.__navStack[window.__navStack.length - 1] || "dashboard";
      if (prev === "dashboard") showDashboard();
      else loadSection(prev);
    }

    const btnBack = document.getElementById("btnBack");
    if (btnBack) btnBack.addEventListener("click", goBack);
  </script>
</body>
</html>